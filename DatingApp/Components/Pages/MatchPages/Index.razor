@page "/matches"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using DatingApp.Domain
@using DatingApp.Data
@inject IDbContextFactory<DatingAppContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Matches</PageTitle>

<h1>Matches</h1>

@if (context is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <QuickGrid Class="table" Items="context.Match">
        <PropertyColumn Property="m => m.MatchDate" Title="Matched On" />
        <PropertyColumn Property="m => m.Active" Title="Status" />
        <PropertyColumn Property="m => m.UserId_One" Title="User One" />
        <PropertyColumn Property="m => m.UserId_Two" Title="User Two" />

        @if (!UserIsAdmin)
        {
            <TemplateColumn Context="match">
                <a href="@($"matches/edit?matchid={match.MatchId}")">Unmatch</a> |
                <a href="@($"matches/details?matchid={match.MatchId}")">Details</a>
            </TemplateColumn>
        }
    </QuickGrid>
}

@code {
    private DatingAppContext context = default!;
    private bool UserIsAdmin;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        UserIsAdmin = user.IsInRole("Administrator");

        currentUserId = user.FindFirst("sub")?.Value
                     ?? user.FindFirst("nameidentifier")?.Value;
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
