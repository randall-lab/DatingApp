@page "/matches"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@using DatingApp.Data
@inject IDbContextFactory<DatingAppContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Matches</PageTitle>

@* 'welcome-title' class to match EXAMPLES styling *@
<h1 class="welcome-title">Matches</h1>
<hr />

@* Wrapped content in 'matches-container' for flexbox spacing *@
<div class="matches-container">
    @if (matches == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (!matches.Any())
    {
        <p class="no-data">No matches found.</p>
    }
    else
    {
        @foreach (var match in matches)
        {
            @* Table/QuickGrid with 'match-card' divs *@
            <div class="match-card">
                @if (!UserIsAdmin)
                {
                    @* USER VIEW: Show the circular profile image and match info *@
                    <div class="match-profile">
                        <img src="@match.OtherUserPhoto" alt="Profile Photo" class="profile-img-circle" />
                        <div class="match-info">
                            <h2 class="profile-name">@match.OtherUserName</h2>
                            <p class="match-meta">Matched on: @match.MatchDate.ToShortDateString()</p>
                            <span class="status-badge @(match.Active ? "active" : "inactive")">
                                @(match.Active ? "Connected" : "Inactive")
                            </span>
                        </div>
                    </div>
                }
                else
                {
                    @* ADMIN VIEW: Show both users involved in the match *@
                    <div class="admin-match-view">
                        <div class="admin-user-info">
                            <strong>User One:</strong> @match.UserOneName <small>(@match.UserId_One)</small>
                        </div>
                        <div class="admin-user-info">
                            <strong>User Two:</strong> @match.UserTwoName <small>(@match.UserId_Two)</small>
                        </div>
                        <div class="match-meta">
                            <strong>Date:</strong> @match.MatchDate.ToShortDateString() |
                            <span class="status-badge @(match.Active ? "active" : "inactive")">
                                @(match.Active ? "Active" : "Disabled")
                            </span>
                        </div>
                    </div>
                }

                @* action buttons (Edit/Delete) to the right side of the card *@
                <div class="match-actions">
                    <a href="@($"matches/edit?matchid={match.MatchId}")" class="btn-action edit">Edit</a>
                    @if (UserIsAdmin)
                    {
                        <a href="@($"matches/delete?matchid={match.MatchId}")" class="btn-action delete">Delete</a>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Match>? matches;
    private bool UserIsAdmin;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        UserIsAdmin = user.IsInRole("Administrator");

        currentUserId = user.FindFirst("sub")?.Value
                     ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        IQueryable<Match> query;
        if (UserIsAdmin)
        {
            query = db.Match;
        }
        else
        {
            // showing all matches involving the user for the index
            query = db.Match.Where(m => (m.UserId_One == currentUserId || m.UserId_Two == currentUserId) && m.Active);
        }

        matches = await query.ToListAsync();

        // Populate details for the card view
        foreach (var m in matches)
        {
            m.UserOneName = db.Profile.Where(p => p.UserId == m.UserId_One).Select(p => p.FirstName + " " + p.LastName).FirstOrDefault();
            m.UserTwoName = db.Profile.Where(p => p.UserId == m.UserId_Two).Select(p => p.FirstName + " " + p.LastName).FirstOrDefault();

            string otherUserId = m.UserId_One == currentUserId ? m.UserId_Two : m.UserId_One;
            var otherProfile = db.Profile.FirstOrDefault(p => p.UserId == otherUserId);
            m.OtherUserName = otherProfile?.FirstName + " " + otherProfile?.LastName;
            m.OtherUserPhoto = otherProfile?.PhotoURL;
        }
    }
}