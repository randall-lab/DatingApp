@page "/matches/edit"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "User")]

<PageTitle>Edit Match</PageTitle>

<h1>Edit Match</h1>
<hr />

@if (Match is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <EditForm Model="Match" OnValidSubmit="UpdateMatch">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <!-- Hidden ID -->
                <input type="hidden" name="Match.MatchId" value="@Match.MatchId" />

                <!-- Read-only fields -->
                <div class="mb-3">
                    <label class="form-label">Date Matched:</label>
                    <p class="form-control-plaintext">@Match.MatchDate.ToShortDateString()</p>
                </div>

                <div class="mb-3">
                    <label class="form-label">User:</label>
                    <p class="form-control-plaintext">@Match.UserId_One</p>
                </div>

                <div class="mb-3">
                    <label class="form-label">Partner:</label>
                    <p class="form-control-plaintext">@Match.UserId_Two</p>
                </div>

                <!-- Editable field -->
                <div class="mb-3">
                    <label for="active" class="form-label">Active:</label>
                    <InputCheckbox id="active" @bind-Value="Match.Active" class="form-check-input" />
                    <ValidationMessage For="() => Match.Active" />
                </div>

                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/matches">Back to List</a>
</div>

@code {
    [SupplyParameterFromQuery]
    private int MatchId { get; set; }

    [SupplyParameterFromForm]
    private Match? Match { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Match ??= await context.Match.FirstOrDefaultAsync(m => m.MatchId == MatchId);

        if (Match is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateMatch()
    {
        using var context = DbFactory.CreateDbContext();

        // Only update Active
        var existing = await context.Match.FirstOrDefaultAsync(m => m.MatchId == MatchId);
        if (existing is not null)
        {
            existing.Active = Match!.Active;
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/matches");
    }
}
