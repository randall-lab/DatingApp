@page "/swipe"
@using DatingApp.Data
@using DatingApp.Domain
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<DatingAppContext> DbFactory
@inject UserManager<DatingAppUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

<h1>Swipe</h1>

@if (CurrentProfile is null)
{
    <p><em>No more candidates</em></p>
}
else
{
    <EditForm Model="CurrentSwipe" OnValidSubmit="HandleSwipe" FormName="swipe">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card text-center" style="max-width:400px;">
            @if (!string.IsNullOrEmpty(CurrentProfile.PhotoURL))
            {
                <img src="@CurrentProfile.PhotoURL" class="card-img-top"
                     style="max-height:300px;object-fit:cover;" />
            }
            <div class="card-body">
                <h3>@CurrentProfile.FirstName, @CurrentProfile.Age</h3>
                <p>@CurrentProfile.Bio</p>
                <p>@CurrentProfile.Interest</p>

                <!-- Hidden fields -->
                <InputText type="hidden" @bind-Value="CurrentSwipe.UserId_From" />
                <InputText type="hidden" @bind-Value="CurrentSwipe.UserId_To" />

                <div class="mt-2">
                    <!-- CHANGED: removed hidden IsLiked checkbox -->
                    <!-- CHANGED: Like button sets IsLike true, IsDislike false -->
                    <button type="submit" class="btn btn-success me-2"
                            @onclick="() => { CurrentSwipe.IsLiked = true; CurrentSwipe.IsDisliked = false; }">
                        Like
                    </button>

                    <!-- CHANGED: Pass button sets IsLike false, IsDislike true -->
                    <button type="submit" class="btn btn-danger"
                            @onclick="() => { CurrentSwipe.IsLiked = false; CurrentSwipe.IsDisliked = true; }">
                        Pass
                    </button>
                </div>
            </div>
        </div>
    </EditForm>
}

@if (!string.IsNullOrEmpty(MatchMessage))
{
    <div class="alert alert-success mt-3">@MatchMessage</div>
}

@code {
    private Profile? CurrentProfile;
    private Swipe? CurrentSwipe;
    private string? currentUserId;
    private string? MatchMessage;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        currentUserId = await UserManager.GetUserIdAsync(user);

        await LoadNextCandidate();
    }

    private async Task LoadNextCandidate()
    {
        using var context = DbFactory.CreateDbContext();

        CurrentProfile = await context.Profile
            .Where(p => p.UserId != currentUserId)
            .OrderBy(p => Guid.NewGuid())
            .FirstOrDefaultAsync();

        if (CurrentProfile is not null)
        {
            CurrentSwipe = new Swipe
            {
                UserId_From = currentUserId!,
                UserId_To = CurrentProfile.UserId
                // CHANGED: IsLike/IsDislike will be set by buttons
            };
        }
        else
        {
            CurrentSwipe = null;
        }

        MatchMessage = null;
    }

    private async Task HandleSwipe()
    {
        if (CurrentSwipe is null) return;

        CurrentSwipe.SwipeDate = DateTime.Now; // local laptop time

        using var context = DbFactory.CreateDbContext();
        context.Swipe.Add(CurrentSwipe);
        await context.SaveChangesAsync();

        // CHANGED: check IsLike instead of IsLiked
        if (CurrentSwipe.IsLiked)
        {
            bool mutual = await context.Swipe.AnyAsync(s =>
                s.UserId_From == CurrentSwipe.UserId_To &&
                s.UserId_To == CurrentSwipe.UserId_From &&
                s.IsLiked);

            if (mutual)
            {
                MatchMessage = $"🎉 It's a match with {CurrentProfile?.FirstName}!";
            }
        }

        await LoadNextCandidate();
        StateHasChanged();
    }
}
