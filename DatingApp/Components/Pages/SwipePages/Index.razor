@page "/swipes"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@using DatingApp.Data
@inject IDbContextFactory<DatingAppContext> DbFactory

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Swipes</PageTitle>

<h1 class="welcome-title">Swipes</h1>
<hr />

<div class="swipes-container">
    @if (swipes == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (!swipes.Any())
    {
        <p class="no-data">No swipes found.</p>
    }
    else
    {
        @foreach (var s in swipes)
        {
            <div class="swipe-card">
                <div class="admin-swipe-view">
                    <div class="admin-user-info">
                        <strong>From:</strong> @s.UserFromName <small>(@s.UserId_From)</small>
                    </div>
                    <div class="admin-user-info">
                        <strong>To:</strong> @s.UserToName <small>(@s.UserId_To)</small>
                    </div>
                    <div class="swipe-meta">
                        <strong>Date:</strong> @s.SwipeDate.ToShortDateString() |
                        <span class="status-badge @(s.IsLiked ? "active" : "inactive")">
                            @(s.IsLiked ? "Liked" : "Passed")
                        </span>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Swipe>? swipes;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        swipes = await db.Swipe.ToListAsync();

        foreach (var s in swipes)
        {
            s.UserFromName = db.Profile
                .Where(p => p.UserId == s.UserId_From)
                .Select(p => p.FirstName + " " + p.LastName)
                .FirstOrDefault();

            s.UserToName = db.Profile
                .Where(p => p.UserId == s.UserId_To)
                .Select(p => p.FirstName + " " + p.LastName)
                .FirstOrDefault();
        }
    }
}
