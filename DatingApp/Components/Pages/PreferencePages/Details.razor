@page "/preferences/details"
@using DatingApp.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<DatingAppUser> UserManager


@attribute [Authorize(Roles = "Administrator,User")]


<PageTitle>Preference Details</PageTitle>

<h1>Preference Details</h1>
<hr />

@if (Preference is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card" style="max-width:600px;">
        <div class="card-body">
            <h3>My Preferences</h3>

            <p><strong>Preferred Gender:</strong> @(string.IsNullOrEmpty(Preference.PreferredGender) ? "Not set" : Preference.PreferredGender)</p>
            <p><strong>Age Range:</strong> @Preference.MinAge – @Preference.MaxAge</p>
            <p><strong>Search Radius:</strong> @Preference.LocationRadius km</p>

            <div class="mt-3">
                <a class="btn btn-primary" href="@($"/preferences/edit?id={Preference.PreferenceId}")">Edit</a>
                <a class="btn btn-secondary" href="/preferences">Back to List</a>
            </div>
        </div>
    </div>
}

@code {
    private Preference? Preference;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Get current user + role
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        var userId = await UserManager.GetUserIdAsync(user);
        var isAdmin = await UserManager.IsInRoleAsync(user, "Administrator");

        if (isAdmin)
        {
            // Admin can fetch by Id
            Preference = await context.Preference.FirstOrDefaultAsync(p => p.PreferenceId == Id);
        }
        else
        {
            // Normal user: always fetch their own record
            Preference = await context.Preference.FirstOrDefaultAsync(p => p.UserId == userId);

            if (Preference == null)
            {
                NavigationManager.NavigateTo("notfound");
                return;
            }
        }

        if (Preference is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }


}
