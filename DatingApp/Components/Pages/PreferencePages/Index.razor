@page "/preferences"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@using DatingApp.Data
@implements IAsyncDisposable
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Preferences</PageTitle>

@* CHANGED: Added 'welcome-title' for brand consistency *@
<h1 class="welcome-title">User Preferences</h1>
<hr />

@* CHANGED: Replaced QuickGrid with a flex container for cards *@
<div class="preferences-container">
    @if (context == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        @foreach (var preference in context.Preference)
        {
            <div class="preference-card">
                <div class="pref-main">
                    @* User Info Section *@
                    <div class="pref-user-header">
                        <h2 class="user-name">@preference.UserFullName</h2>
                        <span class="user-id">ID: @preference.UserId</span>
                    </div>

                    @* Preference Details Grid *@
                    <div class="pref-details">
                        <div class="detail-item">
                            <span class="detail-label">Preferred Gender</span>
                            <span class="detail-value">@preference.PreferredGender</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Age Range</span>
                            <span class="detail-value">@preference.MinAge – @preference.MaxAge years</span>
                        </div>
                    </div>
                </div>

                @* Action Buttons *@
                <div class="pref-actions">
                    <a href="@($"preferences/edit?id={preference.PreferenceId}")" class="btn-action edit">Edit</a>
                    <a href="@($"preferences/delete?id={preference.PreferenceId}")" class="btn-action delete">Delete</a>
                </div>
            </div>
        }
    }
</div>

@code {
    private DatingAppContext context = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        foreach (var pref in context.Preference)
        {
            pref.UserFullName = context.Profile
                .Where(p => p.UserId == pref.UserId)
                .Select(p => p.FirstName + " " + p.LastName)
                .FirstOrDefault();
        }
    }

    public async ValueTask DisposeAsync()
    {
        await context.DisposeAsync();
    }
}