@page "/blocks/delete"
@using DatingApp.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@inject IDbContextFactory<DatingAppContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Unblock User</PageTitle>

<h1 class="welcome-title">Unblock User</h1>
<hr />

@if (block == null)
{
    <p><em>Loading...</em></p>
}
else if (!UserIsAdmin)
{
    <p>Are you sure you want to unblock <strong>@BlockedName</strong>?</p>
    <EditForm method="post" Model="block" OnValidSubmit="DeleteBlock" FormName="delete" Enhance>
        <button type="submit" class="btn btn-danger">Unblock</button>
        <a href="/blocks" class="btn btn-secondary">Cancel</a>
    </EditForm>
}
else
{
    <p>Are you sure you want to delete this block record?</p>
    <div class="admin-block-details">
        <p><strong>Blocker:</strong> @BlockerName (@block.BlockerId)</p>
        <p><strong>Blocked:</strong> @BlockedName (@block.BlockedUserId)</p>
        <p><strong>Date:</strong> @block.BlockedDate.ToShortDateString()</p>
    </div>
    <EditForm method="post" Model="block" OnValidSubmit="DeleteBlock" FormName="delete" Enhance>
        <button type="submit" class="btn btn-danger">Delete</button>
        <a href="/blocks" class="btn btn-secondary">Cancel</a>
    </EditForm>
}

@code {
    private Block? block;
    private string? BlockerName;
    private string? BlockedName;
    private bool UserIsAdmin;
    private string? currentUserId;

    [SupplyParameterFromQuery]
    private int BlockId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        UserIsAdmin = user.IsInRole("Administrator");

        currentUserId = user.FindFirst("sub")?.Value
                     ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        block = await context.Block.FirstOrDefaultAsync(m => m.BlockId == BlockId);

        if (block is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var blockerProfile = await context.Profile.FirstOrDefaultAsync(p => p.UserId == block.BlockerId);
        var blockedProfile = await context.Profile.FirstOrDefaultAsync(p => p.UserId == block.BlockedUserId);

        BlockerName = blockerProfile != null ? blockerProfile.FirstName + " " + blockerProfile.LastName : "";
        BlockedName = blockedProfile != null ? blockedProfile.FirstName + " " + blockedProfile.LastName : "";
    }

    private async Task DeleteBlock()
    {
        using var context = DbFactory.CreateDbContext();
        context.Block.Remove(block!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/blocks");
    }
}
