@page "/messages"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using DatingApp.Domain
@using DatingApp.Data
@implements IAsyncDisposable
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory

@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Messages Overview</PageTitle>

<h1>Messages Overview</h1>

<QuickGrid TGridItem="MessageGroup" Class="table" Items="GroupedMessages">
    <PropertyColumn Property="m => m.MatchId" Title="Match ID" />
    <PropertyColumn Property="m => m.LastMessageText" Title="Last Message" />
    <PropertyColumn Property="m => m.LastTimestamp" Title="Last Activity" />

    <TemplateColumn Context="m">
        <a href="@($"/messages/details?matchId={m.MatchId}")">Details</a> |
        <a href="@($"/messages/delete/{m.MatchId}")">Delete</a>
    </TemplateColumn>
</QuickGrid>


@code {
    private DatingAppContext context = default!;
    private IQueryable<MessageGroup> GroupedMessages = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        // Group messages by MatchId
        GroupedMessages = context.Message
            .GroupBy(m => m.MatchId)
            .Select(g => new MessageGroup
            {
                MatchId = g.Key,
                LastMessageText = g.OrderByDescending(m => m.Timestamp).First().MessageText,
                LastTimestamp = g.Max(m => m.Timestamp)
            })
            .OrderByDescending(m => m.LastTimestamp);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    // DTO for grouped conversations
    private class MessageGroup
    {
        public int MatchId { get; set; }
        public string? LastMessageText { get; set; }
        public DateTime LastTimestamp { get; set; }
    }
}
