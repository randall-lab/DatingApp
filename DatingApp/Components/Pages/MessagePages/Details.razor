@page "/messages/details"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Conversation Details</PageTitle>

<h1>Conversation Details</h1>

@if (messages is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <ul>
        @foreach (var msg in messages)
        {
            <li>
                <strong>@msg.SenderId:</strong> @msg.MessageText
                <span class="text-muted">(@msg.Timestamp)</span>
            </li>
        }
    </ul>
    <a href="/messages">Back to List</a>
}

@code {
    private List<Message>? messages;

    // This is where you declare it
    [SupplyParameterFromQuery]
    private int MatchId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        messages = await context.Message
            .Where(m => m.MatchId == MatchId)
            .OrderBy(m => m.Timestamp)
            .ToListAsync();

        if (messages is null || !messages.Any())
        {
            NavigationManager.NavigateTo("notfound");
        }
    }
}
