@page "/messages/details"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Conversation Details</PageTitle>

<h1>Conversation Details</h1>

@if (messages is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <ul>
        <ul>
            @foreach (var msg in messages)
            {
                <li>
                    <strong>@msg.SenderFirstName:</strong> @msg.MessageText
                    <span class="text-muted">(@msg.Timestamp)</span>
                </li>
            }
        </ul>



    </ul>
    <a href="/messages">Back to List</a>
}

@code {
    private List<Message>? messages;

    [SupplyParameterFromQuery]
    private int MatchId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Load messages
        messages = await context.Message
            .Where(m => m.MatchId == MatchId)
            .OrderBy(m => m.Timestamp)
            .ToListAsync();

        if (messages is null || !messages.Any())
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Collect sender IDs
        var senderIds = messages
            .Where(m => m.SenderId != null)
            .Select(m => m.SenderId!)
            .Distinct()
            .ToList();

        // Load profiles for those senders
        var profiles = await context.Profile
            .Where(p => senderIds.Contains(p.UserId))
            .ToListAsync();

        // Populate SenderFirstName
        foreach (var msg in messages)
        {
            var profile = profiles.FirstOrDefault(p => p.UserId == msg.SenderId);
            msg.SenderFirstName = profile?.FirstName ?? msg.SenderId; // fallback to ID
        }
    }
}
