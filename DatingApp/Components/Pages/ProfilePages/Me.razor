@page "/profiles/me"
@using DatingApp.Data
@using Microsoft.EntityFrameworkCore
@using DatingApp.Domain
@using Microsoft.AspNetCore.Identity
@inject IDbContextFactory<DatingApp.Data.DatingAppContext> DbFactory
@inject UserManager<DatingAppUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<h3>My Profile</h3>

@if (Profile is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card p-3">
        <img src="@Profile.PhotoURL" alt="Profile Photo" style="max-width: 200px;" />

        <h4>@Profile.FirstName @Profile.LastName</h4>
        <p><strong>Age:</strong> @Profile.Age</p>
        <p><strong>Gender:</strong> @Profile.Gender</p>
        <p><strong>Region:</strong> @Profile.RegionName</p>
        <p><strong>Bio:</strong> @Profile.Bio</p>
        <p><strong>Interests:</strong> @Profile.Interest</p>

        <button class="btn btn-primary" @onclick="GoToEdit">Edit Profile</button>
    </div>
}

@code {
    private Profile? Profile { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NavigationManager.NavigateTo("/Account/Login");
            return;
        }

        var userId = await UserManager.GetUserIdAsync(await UserManager.GetUserAsync(user));

        using var context = DbFactory.CreateDbContext();
        Profile = await context.Profile.FirstOrDefaultAsync(p => p.UserId == userId);

        if (Profile is null)
        {
            NavigationManager.NavigateTo("/profiles/edit");
        }
    }

    private void GoToEdit()
    {
        NavigationManager.NavigateTo("/profiles/edit");
    }
}
